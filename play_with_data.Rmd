---
title: "COVID-19 Data"
output: github_document
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# get latest data
remotes::install_github("kjhealy/covdata")

library(tidyverse)
library(hubbeR)
library(covdata)
library(ggrepel)
library(paletteer)
library(prismatic)

## Convenince "Not in" operator
"%nin%" <- function(x, y) {
  return( !(x %in% y) )
}

ca_county_pops <- read_csv("ca_county_pops.csv") %>% 
  mutate(county = str_replace(County, " County", ""))
il_county_pops <- read_csv("il_county_pops.csv") %>% 
  mutate(county = str_replace(County, " County", ""))
state_pops <- read_csv("state_populations.csv")

top_n_counties <- function(data, n = 5) {
  data %>%
  group_by(county) %>%
  filter(date == max(date)) %>%
  ungroup() %>%
  top_n(n, wt = cases) %>%
  pull(county)
}
```


```{r}
counties_to_show <- c("Los Angeles", "San Diego", "Santa Clara", "Orange", "San Francisco", "Riverside", "Alameda")

nytcovcounty %>% 
  filter(state == "California") %>% 
  group_by(county) %>% 
  mutate(days_since = date - min(date),
         core = if_else(county %nin% counties_to_show, "", county),
         end_label = if_else(date == max(date), core, NA_character_)) %>% 
  ggplot(aes(x = days_since, y = cases, group = county, label = end_label, color = core)) +
  geom_line() +
  geom_text_repel(segment.color = NA, nudge_x = 2, nudge_y = 0.1) +
  #scale_y_log10() +
  #scale_x_continuous(limits = c(0,100)) +
  scale_color_manual(values = ghColorSelect("grey-400", "blue", "red", "green", "yellow-800", "purple", "orange", "pink")) +
  guides(color = FALSE) +
  labs(title = "Cumulative Cases of Coronavirus in California Counties",
       x = "Days Since First Case",
       y = "Cumulative Cases")
ggsave("img/ca_counties.png", width = 8, height = 6, dpi = 300)
```

```{r}
ca_counties <- nytcovcounty %>% 
  filter(state == "California")
ca_counties %>% 
  group_by(county) %>% 
  mutate(days_since = date - min(date),
         core = if_else(county %nin% counties_to_show, "", county),
         linesize = if_else(core == "", 0.5, 1),
         end_label = if_else(date == max(date), core, NA_character_)) %>% 
  ungroup() %>% 
  left_join(ca_county_pops, by = "county") %>% 
  mutate(cases_per_capita = 1000 * cases / Population) %>% 
  ggplot(aes(x = days_since, y = cases_per_capita, group = county, label = end_label, color = core)) +
  geom_line(aes(size = linesize)) +
  geom_text_repel(segment.color = NA, nudge_x = 2, nudge_y = 0.1) +
  #scale_y_log10() +
  #scale_x_continuous(limits = c(0,100)) +
  scale_color_manual(values = ghColorSelect("grey-400", "blue", "red", "green", "yellow-800", "purple", "orange", "pink")) +
  scale_size_identity() +
  guides(color = FALSE) +
  labs(title = "Cases Per Capita of Coronavirus in California Counties",
       x = "Days Since First Case",
       y = "Cases Per 1,000 Population")
ggsave("img/ca_counties_per_capita.png", width = 8, height = 6, dpi = 300)
```

```{r}
ca_counties <- nytcovcounty %>% 
  filter(state == "California") %>% 
  group_by(county) %>% 
  arrange(date) %>% 
  mutate(new_cases = coalesce(cases - lag(cases),1))
ca_counties
```




```{r}
ca_counties %>% 
  group_by(county) %>% 
  mutate(days_since = date - min(date),
         core = if_else(county %nin% counties_to_show, "", county),
         end_label = if_else(date == max(date), core, NA_character_)) %>% 
  ungroup() %>% 
  left_join(ca_county_pops, by = "county") %>% 
  mutate(cases_per_capita = 1000 * cases / Population) %>% 
  arrange(desc(cases_per_capita)) %>% 
  select(date, county, cases, Population, cases_per_capita)
```


```{r}
nytcovcounty %>% 
  filter(state == "California") %>% 
  group_by(county) %>% 
  mutate(days_since = date - min(date),
         core = if_else(county %nin% counties_to_show, "", county),
         end_label = if_else(date == max(date), core, NA_character_)) %>% 
  ggplot(aes(x = days_since, y = deaths, group = county, label = end_label, color = core)) +
  geom_line() +
  geom_text_repel(segment.color = NA, nudge_x = 2, nudge_y = 0.1) +
  #scale_y_log10() +
  #scale_x_continuous(limits = c(0,100)) +
  scale_color_manual(values = ghColorSelect("grey-400", "blue", "red", "green", "yellow-800", "purple", "orange", "pink")) +
  guides(color = FALSE) +
  labs(title = "Cumulative Deaths of Coronavirus in California Counties",
       x = "Days Since First Case",
       y = "Cumulative Deaths")
ggsave("img/ca_counties_deaths.png", width = 8, height = 6, dpi = 300)
```



```{r}
top_n_counties <- function(data, n = 5) {
  data %>%
  group_by(county) %>%
  filter(date == max(date)) %>%
  ungroup() %>%
  top_n(n, wt = cases) %>%
  pull(county)
}

ny_counties <- nytcovcounty %>% 
  filter(state == "New York")
ny_counties %>% 
  group_by(county) %>% 
  mutate(days_since = date - min(date),
         core = if_else(county %nin% top_n_counties(ny_counties, n=7), "", county),
         end_label = if_else(date == max(date), core, NA_character_)) %>% 
  ggplot(aes(x = date, y = cases, group = county, label = end_label, color = core)) +
  geom_line() +
  geom_text_repel(segment.color = NA, nudge_x = 2, nudge_y = 0.1) +
  #scale_y_log10() +
  #scale_x_continuous(limits = c(0,100)) +
  scale_color_manual(values = ghColorSelect("grey-400", "blue", "red", "green", "yellow-800", "purple", "orange", "pink")) +
  guides(color = FALSE) +
  labs(title = "Cumulative Cases of Coronavirus in NMew York Counties",
       x = "Days Since First Case",
       y = "Cumulative Cases")
```


## Illinois


```{r}
il_counties <- nytcovcounty %>% 
  filter(state == "Illinois")
il_counties %>% 
  group_by(county) %>% 
  mutate(days_since = date - min(date),
         core = if_else(county %nin% top_n_counties(il_counties, n=7), "", county),
         end_label = if_else(date == max(date), core, NA_character_)) %>% 
  ungroup() %>% 
  left_join(il_county_pops, by = "county") %>% 
  mutate(cases_per_capita = 1000 * cases / Population) %>% 
  ggplot(aes(x = days_since, y = cases_per_capita, group = county, label = end_label, color = core)) +
  geom_line() +
  geom_text_repel(segment.color = NA, nudge_x = 2, nudge_y = 0.1) +
  #scale_y_log10() +
  #scale_x_continuous(limits = c(0,100)) +
  scale_color_manual(values = ghColorSelect("grey-400", "blue", "red", "green", "yellow-800", "purple", "orange", "pink")) +
  guides(color = FALSE) +
  labs(title = "Cumulative Cases of Coronavirus in Illinois Counties",
       x = "Days Since First Case",
       y = "Cases Per 1,000")
ggsave("img/il_counties_per_capita.png", width = 8, height = 6, dpi = 300)
```



```{r}
apple_mobility %>% 
  filter(region == "San Francisco - Bay Area" & transportation_type == "walking") %>% 
  ggplot(aes(x = date, y = index)) +
  geom_line()

apple_mobility %>% 
  filter(region == "Los Angeles" & transportation_type == "walking") %>% 
  ggplot(aes(x = date, y = index)) +
  geom_line()
```



```{r}
top_n_state <- function(data, n = 5, wt = cases) {
  data %>%
  group_by(state) %>%
  filter(date == max(date)) %>%
  ungroup() %>%
  top_n(n, wt = {{ wt }}) %>%
  pull(state)
}

state_df <- nytcovstate %>% 
  left_join(state_pops, by = c("state" = "State")) %>% 
  mutate(cases_per_capita = 1000 * cases / Pop)
state_df %>% 
  group_by(state) %>% 
  mutate(days_since = date - min(date),
         core = if_else(state %nin% top_n_state(state_df, n=7, wt = cases_per_capita), "", state),
         end_label = if_else(date == max(date), core, NA_character_)) %>% 
  ungroup() %>% 
  ggplot(aes(x = days_since, y = cases_per_capita, group = state, label = end_label, color = core)) +
  geom_line() +
  geom_text_repel(segment.color = NA, nudge_x = 2, nudge_y = 0.1) +
  #scale_y_log10() +
  #scale_x_continuous(limits = c(0,100)) +
  scale_color_manual(values = ghColorSelect("grey-400", "blue", "red", "green", "yellow-800", "purple", "orange", "pink")) +
  guides(color = FALSE) +
  labs(title = "State Per Capita Cases for Top 7 States",
       x = "Days Since First Case",
       y = "Cases Per 1,000") +
  nowt()
```

```{r}
state_df %>% 
  group_by(state) %>% 
  mutate(days_since = date - min(date),
         core = if_else(Region != "South", "", state),
         end_label = if_else(date == max(date), core, NA_character_)) %>% 
  ungroup() %>% 
  filter(Region == "South") %>% 
  ggplot(aes(x = days_since, y = cases_per_capita, group = state, label = end_label, color = core)) +
  geom_line() +
  geom_text_repel(segment.color = NA, nudge_x = 2, nudge_y = 0.1) +
  #scale_y_log10() +
  #scale_x_continuous(limits = c(0,100)) +
  #scale_color_manual(values = ghColorSelect("grey-400", "blue", "red", "green", "yellow-800", "purple", "orange", "pink")) +
  guides(color = FALSE) +
  labs(title = "State Per Capita Cases for the South",
       x = "Days Since First Case",
       y = "Cases Per 1,000") +
  nowt()
ggsave("img/southern_states.png", width = 8, height = 6, dpi = 400)
```


```{r}
state_df %>% 
  #filter(cases >= 100) %>% 
  group_by(state) %>% 
  mutate(days_since = date - min(date),
         core = if_else(Region != "Midwest", "", state),
         end_label = if_else(date == max(date), core, NA_character_)) %>% 
  ungroup() %>% 
  filter(Region == "Midwest") %>% 
  ggplot(aes(x = days_since, y = cases_per_capita, group = state, label = end_label, color = core)) +
  geom_line() +
  geom_text_repel(segment.color = NA, nudge_x = 2, nudge_y = 0.1) +
  #scale_y_log10() +
  #scale_x_continuous(limits = c(0,100)) +
  #scale_color_manual(values = ghColorSelect("grey-400", "blue", "red", "green", "yellow-800", "purple", "orange", "pink")) +
  guides(color = FALSE) +
  labs(title = "State Per Capita Cases for the Midwest",
       x = "Days Since First Case",
       y = "Cases Per 1,000") +
  nowt()
ggsave("img/midwest_states.png", width = 8, height = 6, dpi = 400)
```





```{r}
state_df %>% 
  group_by(state) %>% 
  mutate(days_since = date - min(date),
         core = if_else(Region != "West Coast", "", state),
         end_label = if_else(date == max(date), core, NA_character_)) %>% 
  ungroup() %>% 
  filter(Region == "West Coast") %>% 
  ggplot(aes(x = days_since, y = cases_per_capita, group = state, label = end_label, color = core)) +
  geom_line() +
  geom_text_repel(segment.color = NA, nudge_x = 2, nudge_y = 0.1) +
  #scale_y_log10() +
  #scale_x_continuous(limits = c(0,100)) +
  #scale_color_manual(values = ghColorSelect("grey-400", "blue", "red", "green", "yellow-800", "purple", "orange", "pink")) +
  guides(color = FALSE) +
  labs(title = "State Per Capita Cases for the West Coast",
       x = "Days Since First Case",
       y = "Cases Per 1,000") +
  nowt()
ggsave("img/west_states.png", width = 8, height = 6, dpi = 400)
```


